// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
}

model User {
  id           String   @id @default(uuid())
  name         String   @unique
  passwordHash String
  role         Role     @default(Viewer)
  groups       Group[]
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
}

model Group {
  id        String    @id @default(uuid())
  name      String    @unique
  users     User[]
  libraries Library[]
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
}

model Library {
  id          String       @id @default(uuid())
  name        String
  path        String       // Filesystem path where media is stored
  libraryType LibraryType
  groups      Group[]      // Groups that can access this library
  collections Collection[] // Collections within this library
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt
}

model Collection {
  id             String          @id @default(uuid())
  name           String
  collectionType CollectionType  @default(Generic)

  // Belongs to a library
  library   Library  @relation(fields: [libraryId], references: [id], onDelete: Cascade)
  libraryId String

  // Self-referential hierarchy: a collection can have a parent collection
  parent    Collection?  @relation("CollectionHierarchy", fields: [parentId], references: [id], onDelete: Cascade)
  parentId  String?
  children  Collection[] @relation("CollectionHierarchy")

  // Media within this collection
  media     Media[]

  // Type-specific metadata (one-to-one, based on collectionType)
  showDetails   ShowDetails?
  seasonDetails SeasonDetails?
  artistDetails ArtistDetails?
  albumDetails  AlbumDetails?

  // Images associated with this collection
  images    Image[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([libraryId])
  @@index([parentId])
  @@index([collectionType])
}

enum LibraryType {
  Television
  Film
  Music
}

enum CollectionType {
  Generic  // Default, untyped folder
  Show     // TV show container
  Season   // Season within a show
  Film     // Movie container (film library)
  Artist   // Music artist container
  Album    // Album within an artist
}

enum Role {
  Admin    // Full access: manage users, settings, all content and actions
  Editor   // Can create, edit, and delete content
  Viewer   // Read-only access to content
}

// Single Table Inheritance (STI) model for Media
model Media {
  id          String    @id @default(uuid())

  // Shared properties for both Video and Audio
  path        String    // File location/path
  duration    Int       // Length in seconds
  name        String    // Human-readable name

  // Discriminator field
  type        MediaType

  // Video-specific: path to trickplay thumbnails folder for scrubbing preview
  thumbnails  String?

  // Type-specific details (one-to-one)
  videoDetails VideoDetails?
  audioDetails AudioDetails?

  // Belongs to a collection
  collection   Collection? @relation(fields: [collectionId], references: [id], onDelete: SetNull)
  collectionId String?

  // Images associated with this media
  images      Image[]

  // Media streams (audio/video/subtitle tracks)
  streams     MediaStream[]

  // Timestamps
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@index([type])
  @@index([collectionId])
}

// Media stream information (audio, video, subtitle tracks)
model MediaStream {
  id          String      @id @default(uuid())

  // Relationship to Media
  media       Media       @relation(fields: [mediaId], references: [id], onDelete: Cascade)
  mediaId     String

  // Stream identification
  streamIndex Int         // FFmpeg stream index (0, 1, 2, etc.)
  streamType  StreamType  // Audio, Video, Subtitle

  // Codec information
  codec       String?     // Codec name (e.g., "aac", "h264", "subrip")
  codecLong   String?     // Full codec name (e.g., "AAC (Advanced Audio Coding)")

  // Language and labeling
  language    String?     // ISO 639-1/639-2 language code (e.g., "en", "eng", "spa")
  title       String?     // Stream title/label (e.g., "English 5.1", "Director's Commentary")
  isDefault   Boolean     @default(false)  // FFmpeg default flag
  isForced    Boolean     @default(false)  // Forced subtitle flag

  // Audio-specific properties
  channels    Int?        // Number of audio channels (2, 6, 8, etc.)
  channelLayout String?   // Channel layout (e.g., "stereo", "5.1", "7.1")
  sampleRate  Int?        // Audio sample rate in Hz (e.g., 48000)
  bitRate     Int?        // Bit rate in bits/second

  // Video-specific properties
  width       Int?        // Video width in pixels
  height      Int?        // Video height in pixels
  frameRate   Float?      // Frame rate (e.g., 23.976, 29.97, 60)

  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt

  @@index([mediaId])
  @@index([streamType])
  @@unique([mediaId, streamIndex])
}

enum StreamType {
  Video
  Audio
  Subtitle
}

enum MediaType {
  Video
  Audio
}

// Video-specific metadata
model VideoDetails {
  id          String   @id @default(uuid())

  // Relationship to Media
  media       Media    @relation(fields: [mediaId], references: [id], onDelete: Cascade)
  mediaId     String   @unique

  // Episode information (for TV shows)
  showName    String?  // Name of the show (e.g., "Breaking Bad")
  season      Int?     // Season number
  episode     Int?     // Episode number

  // General video metadata
  description String?  // Plot summary / description
  releaseDate DateTime?
  rating      String?  // Content rating (e.g., "PG-13", "TV-MA")

  // Cast and crew
  credits     Credit[]

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

// Cast and crew credits for videos
model Credit {
  id             String       @id @default(uuid())

  videoDetails   VideoDetails @relation(fields: [videoDetailsId], references: [id], onDelete: Cascade)
  videoDetailsId String

  name           String       // Person's name
  role           String?      // Role/character name (for actors) or job title (for crew)
  creditType     CreditType   // Actor, Director, Writer, etc.
  order          Int?         // Display order (e.g., billing order for actors)

  // Link to Person entity
  person         Person?      @relation(fields: [personId], references: [id], onDelete: SetNull)
  personId       String?

  // Images (photos) for this person
  images         Image[]

  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt

  @@index([videoDetailsId])
  @@index([creditType])
  @@index([personId])
}

enum CreditType {
  Actor
  Director
  Writer
  Producer
  Composer
  Cinematographer
  Editor
}

enum ImageType {
  Poster      // Primary vertical artwork (movies, shows, seasons)
  Backdrop    // Horizontal background/hero image
  Logo        // Text-based logo/title treatment
  Thumbnail   // Small preview image
  Still       // Video frame capture
  Photo       // Person photo (for credits)
  AlbumArt    // Album cover art
  ArtistImage // Artist promotional image
}

// Audio-specific metadata
model AudioDetails {
  id          String   @id @default(uuid())

  // Relationship to Media
  media       Media    @relation(fields: [mediaId], references: [id], onDelete: Cascade)
  mediaId     String   @unique

  // Track information
  artist      String?  // Primary artist
  albumArtist String?  // Album artist (may differ from track artist)
  album       String?  // Album name
  track       Int?     // Track number
  disc        Int?     // Disc number (for multi-disc albums)
  year        Int?     // Release year
  genre       String?  // Genre

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

// ============================================
// Collection Detail Models
// ============================================

// TV Show metadata
model ShowDetails {
  id           String   @id @default(uuid())

  // Relationship to Collection
  collection   Collection @relation(fields: [collectionId], references: [id], onDelete: Cascade)
  collectionId String     @unique

  // External scraper reference
  scraperId    String?  // Which scraper provided this data
  externalId   String?  // ID in the external system (e.g., TMDB ID, TVDB ID)

  // Show information
  description  String?  // Plot summary / overview
  releaseDate  DateTime? // First air date
  endDate      DateTime? // Last air date (if ended)
  status       String?  // "Continuing", "Ended", etc.
  rating       Float?   // Average rating
  genres       String?  // Comma-separated genres

  // Cast and crew
  credits      ShowCredit[]

  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@index([scraperId, externalId])
}

// Credits for TV shows
model ShowCredit {
  id            String      @id @default(uuid())

  showDetails   ShowDetails @relation(fields: [showDetailsId], references: [id], onDelete: Cascade)
  showDetailsId String

  name          String      // Person's name
  role          String?     // Character name (for actors) or job title
  creditType    CreditType  // Actor, Director, Writer, etc.
  order         Int?        // Display order

  // Link to Person entity
  person        Person?     @relation(fields: [personId], references: [id], onDelete: SetNull)
  personId      String?

  // Images (photos) for this person
  images        Image[]

  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt

  @@index([showDetailsId])
  @@index([creditType])
  @@index([personId])
}

// TV Season metadata
model SeasonDetails {
  id           String   @id @default(uuid())

  // Relationship to Collection
  collection   Collection @relation(fields: [collectionId], references: [id], onDelete: Cascade)
  collectionId String     @unique

  // External scraper reference
  scraperId    String?
  externalId   String?

  // Season information
  seasonNumber Int?     // Season number
  description  String?  // Season overview
  releaseDate  DateTime? // First air date of this season

  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@index([scraperId, externalId])
}

// Music Artist metadata
model ArtistDetails {
  id           String   @id @default(uuid())

  // Relationship to Collection
  collection   Collection @relation(fields: [collectionId], references: [id], onDelete: Cascade)
  collectionId String     @unique

  // External scraper reference
  scraperId    String?
  externalId   String?

  // Artist information
  biography    String?  // Artist bio
  formedYear   Int?     // Year formed/born
  endedYear    Int?     // Year disbanded (if applicable)
  genres       String?  // Comma-separated genres
  country      String?  // Country of origin

  // Band members (for groups)
  members      ArtistMember[]

  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@index([scraperId, externalId])
}

// Band/group members
model ArtistMember {
  id              String        @id @default(uuid())

  artistDetails   ArtistDetails @relation(fields: [artistDetailsId], references: [id], onDelete: Cascade)
  artistDetailsId String

  name            String        // Member's name
  role            String?       // Instrument/role (e.g., "vocals", "guitar")
  active          Boolean       @default(true) // Current or former member

  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  @@index([artistDetailsId])
}

// Music Album metadata
model AlbumDetails {
  id           String   @id @default(uuid())

  // Relationship to Collection
  collection   Collection @relation(fields: [collectionId], references: [id], onDelete: Cascade)
  collectionId String     @unique

  // External scraper reference
  scraperId    String?
  externalId   String?

  // Album information
  releaseDate  DateTime? // Release date
  releaseType  String?   // "Album", "EP", "Single", "Compilation"
  genres       String?   // Comma-separated genres
  description  String?   // Album description/review
  label        String?   // Record label

  // Production credits
  credits      AlbumCredit[]

  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@index([scraperId, externalId])
}

// Credits for albums (producers, engineers, etc.)
model AlbumCredit {
  id             String       @id @default(uuid())

  albumDetails   AlbumDetails @relation(fields: [albumDetailsId], references: [id], onDelete: Cascade)
  albumDetailsId String

  name           String       // Person's name
  role           String?      // Job title (e.g., "Producer", "Mixing Engineer")

  // Link to Person entity
  person         Person?      @relation(fields: [personId], references: [id], onDelete: SetNull)
  personId       String?

  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt

  @@index([albumDetailsId])
  @@index([personId])
}

// Settings model for system-wide configuration
// This should be a singleton table with only one row
model Settings {
  id           String   @id @default(uuid())
  instanceName String   // Main name of the instance
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
}

// ============================================
// Image Storage
// ============================================

// Unified image storage for all entity types
model Image {
  id           String    @id @default(uuid())

  // Polymorphic references (only one should be set)
  mediaId      String?
  collectionId String?
  showCreditId String?
  creditId     String?
  personId     String?

  // Image metadata
  imageType    ImageType
  path         String    // Relative path within image storage directory
  width        Int?
  height       Int?
  format       String?   // webp, jpg, png
  fileSize     Int?      // bytes

  // Source tracking
  sourceUrl    String?   // Original URL (for re-download if needed)
  scraperId    String?   // Which scraper provided this

  isPrimary    Boolean   @default(false)

  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  // Relations
  media        Media?      @relation(fields: [mediaId], references: [id], onDelete: Cascade)
  collection   Collection? @relation(fields: [collectionId], references: [id], onDelete: Cascade)
  showCredit   ShowCredit? @relation(fields: [showCreditId], references: [id], onDelete: Cascade)
  credit       Credit?     @relation(fields: [creditId], references: [id], onDelete: Cascade)
  person       Person?     @relation(fields: [personId], references: [id], onDelete: Cascade)

  @@index([mediaId, imageType])
  @@index([collectionId, imageType])
  @@index([showCreditId])
  @@index([creditId])
  @@index([personId])
}

// ============================================
// Person Entity - Links credits across media
// ============================================

model Person {
  id           String    @id @default(uuid())

  // Basic info
  name         String
  biography    String?
  birthDate    DateTime?
  deathDate    DateTime?
  birthPlace   String?
  knownFor     String?   // "Acting", "Directing", etc.

  // External IDs for cross-referencing
  tmdbId       Int?      @unique
  tvdbId       Int?      @unique
  imdbId       String?   @unique

  // Timestamps
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  // Relations
  credits      Credit[]
  showCredits  ShowCredit[]
  albumCredits AlbumCredit[]
  images       Image[]

  @@index([name])
}
